{% extends "base.html" %} {% block content %}
<div class="column is-4 is-offset-4">
    <h3 class="title">Facial Recognition Login</h3>
    <div class="box">
        {% with messages = get_flashed_messages() %} {% if messages %}
        <div class="notification is-danger">
            {{ messages[0] }}. Go to <a href="{{ url_for('auth.login') }}">login page</a>.
        </div>
        {% endif %} {% endwith %}
			<div class="field">
				<div id ="face-input">
                    <video id="myVideo"  autoplay></video>
                </div>
			</div>
            <button id="button" class="button is-block is-info is-large is-fullwidth">Login</button>

			<script>
				let v = document.getElementById("myVideo");
				let b = document.getElementById("button");
				//create a canvas to grab an image for upload
				let imageCanvas = document.createElement('canvas');
				let imageCtx = imageCanvas.getContext("2d");
				
				var redirect = function(url, method) {
					var form = document.createElement('form');
					form.method = method;
					form.action = url;
					form.submit();
				};
				function postFile(file) {
					let formdata = new FormData();
					formdata.append("image", file);
					let xhr = new XMLHttpRequest();
					xhr.open('POST', 'http://localhost:5000/do_facialrecognition', true);
					xhr.onload = function () {
						if (this.status === 200) {
							xhr.abort();
						}
					};
					xhr.send(formdata);
				}
				function sendImagefromCanvas() {
				//Make sure the canvas is set to the current video size
				imageCanvas.width = v.videoWidth;
				imageCanvas.height = v.videoHeight;

				imageCtx.drawImage(v, 0, 0, v.videoWidth, v.videoHeight);
				console.log(imageCtx);
				//Convert the canvas to blob and post the file
				imageCanvas.toBlob(postFile, 'image/jpeg');
				
				}	
				
				 window.onload = function () {
					//Get camera video
					navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: false })
						.then(stream => {
							v.srcObject = stream;
						})
						.catch(err => {
							console.log('navigator.getUserMedia error: ', err)
						});
				};
				 //Take a picture on click

				//Take a picture on click
				b.onclick = function () {
					console.log('click');
					sendImagefromCanvas();
				};

			</script>
 
    </div>
</div>
{% endblock %}